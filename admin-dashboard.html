<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | BAPS APC Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/src/baps-identity.css">
</head>

<body>

    <!-- SIDEBAR -->
    <div class="baps-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">Sahajanand APC</div>
            <div class="sidebar-subtitle">Management Portal</div>
        </div>
        <div class="nav-links">
            <a href="admin-dashboard.html" class="nav-item active"><i class="fa-solid fa-grid-2"></i> Dashboard</a>

            <div class="menu-cat"
                style="padding: 0.8rem 1.5rem 0.2rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--c-gold); opacity: 0.8; font-weight: 600; margin-top: 0.5rem;">
                Student Operations</div>
            <a href="modules/applications-admin.html" class="nav-item"><i class="fa-solid fa-users"></i>
                Applications</a>
            <a href="modules/verification-admin.html" class="nav-item"><i class="fa-solid fa-check-double"></i>
                Verification</a>
            <a href="modules/gatepass-admin.html" class="nav-item"><i class="fa-solid fa-ticket"></i> Gatepass</a>
            <a href="modules/fee-management.html" class="nav-item"><i class="fa-solid fa-money-bill-wave"></i> Fee
                Mgmt</a>
            <a href="modules/exams-admin.html" class="nav-item"><i class="fa-solid fa-file-signature"></i> Exams</a>
            <a href="modules/helpdesk-admin.html" class="nav-item"><i class="fa-solid fa-headset"></i> Helpdesk</a>
            <a href="modules/satsang-admin.html" class="nav-item"><i class="fa-solid fa-hands-praying"></i> Satsang</a>
            <a href="modules/alumni-admin.html" class="nav-item"><i class="fa-solid fa-user-graduate"></i> Alumni</a>

            <div class="menu-cat"
                style="padding: 0.8rem 1.5rem 0.2rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--c-gold); opacity: 0.8; font-weight: 600; margin-top: 0.5rem;">
                Facilities</div>
            <a href="modules/rooms-admin.html" class="nav-item"><i class="fa-solid fa-bed"></i> Rooms</a>
            <a href="modules/inventory.html" class="nav-item"><i class="fa-solid fa-boxes-stacked"></i> Inventory</a>
            <a href="modules/assets-admin.html" class="nav-item"><i class="fa-solid fa-couch"></i> Fixed Assets</a>
            <a href="modules/library-admin.html" class="nav-item"><i class="fa-solid fa-book-open"></i> Library</a>
            <a href="modules/mess-admin.html" class="nav-item"><i class="fa-solid fa-utensils"></i> Bhojanalay</a>
            <a href="modules/transport-admin.html" class="nav-item"><i class="fa-solid fa-bus"></i> Transport</a>
            <a href="modules/guesthouse-admin.html" class="nav-item"><i class="fa-solid fa-hotel"></i> Guest House</a>
            <a href="modules/medical-admin.html" class="nav-item"><i class="fa-solid fa-notes-medical"></i> Medical</a>

            <div class="menu-cat"
                style="padding: 0.8rem 1.5rem 0.2rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--c-gold); opacity: 0.8; font-weight: 600; margin-top: 0.5rem;">
                Operations</div>
            <a href="modules/staff-admin.html" class="nav-item"><i class="fa-solid fa-user-tie"></i> Staff</a>
            <a href="modules/payroll-admin.html" class="nav-item"><i class="fa-solid fa-file-invoice-dollar"></i>
                Payroll</a>
            <a href="modules/maintenance-admin.html" class="nav-item"><i class="fa-solid fa-screwdriver-wrench"></i>
                Maintenance</a>
            <a href="modules/security-visitors.html" class="nav-item"><i class="fa-solid fa-shield-halved"></i>
                Security</a>
            <a href="modules/government-admin.html" class="nav-item"><i class="fa-solid fa-building-columns"></i>
                Government Hub</a>
            <a href="modules/news-admin.html" class="nav-item"><i class="fa-solid fa-newspaper"></i> News CMS</a>
            <a href="modules/gallery-admin.html" class="nav-item"><i class="fa-solid fa-images"></i> Gallery</a>
            <a href="modules/settings-admin.html" class="nav-item"><i class="fa-solid fa-gear"></i> Settings</a>
            <a href="modules/analytics-admin.html" class="nav-item"><i class="fa-solid fa-chart-line"></i> Analytics</a>

            <a href="index.html" class="nav-item"
                style="margin-top: 1rem; color: #ff6b6b; border-top: 1px solid #333; padding-top: 1rem;">
                <i class="fa-solid fa-sign-out-alt"></i> Logout
            </a>
        </div>

        <div class="user-panel">
            <div class="avatar-circle" id="avatarInitials">KS</div>
            <div style="flex: 1;">
                <div style="font-weight: bold; font-size: 0.9rem;" id="sideUserName">Kothari Swami</div>
                <div style="font-size: 0.75rem; opacity: 0.7;" id="sideUserRole">Admin Access</div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- HEADER -->
        <div class="top-header header">
            <div class="page-title">
                <h1 id="pageTitle">Dashboard</h1>
                <p id="pageSubtitle">Overview of Hostel Operations</p>
            </div>
            <button onclick="window.location.href='modules/analytics-admin.html'" class="btn-baps btn-gold">
                <i class="fa-solid fa-chart-line"></i> View Global Analytics
            </button>
        </div>

        <!-- DASHBOARD WIDGETS -->
        <div id="section-dashboard" class="cms-section animate-fade">
            <div class="stats-grid"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Widget 1: Applications -->
                <div class="baps-card stat-card" onclick="window.location.href='modules/applications-admin.html'"
                    style="cursor: pointer; transition: transform 0.2s;">
                    <div class="stat-icon"><i class="fa-solid fa-file-contract"></i></div>
                    <div>
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total Applications</div>
                    </div>
                </div>
                <!-- Widget 2: Verification -->
                <div class="baps-card stat-card" onclick="window.location.href='modules/verification-admin.html'"
                    style="cursor: pointer; transition: transform 0.2s;">
                    <div class="stat-icon" style="background:#E8F5E9; color:#2E7D32;"><i
                            class="fa-solid fa-check-circle"></i></div>
                    <div>
                        <div class="stat-value" id="stat-verified">0</div>
                        <div class="stat-label">Verified Students</div>
                    </div>
                </div>
                <!-- Widget 3: Pending -->
                <div class="baps-card stat-card" onclick="window.location.href='modules/verification-admin.html'"
                    style="cursor: pointer; transition: transform 0.2s;">
                    <div class="stat-icon" style="background:#FFF8E1; color:#F57F17;"><i class="fa-solid fa-clock"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">Pending Review</div>
                    </div>
                </div>
                <!-- Widget 4: Rooms -->
                <div class="baps-card stat-card" onclick="window.location.href='modules/rooms-admin.html'"
                    style="cursor: pointer; transition: transform 0.2s;">
                    <div class="stat-icon" style="background:#FFEBEE; color:#C62828;"><i class="fa-solid fa-bed"></i>
                    </div>
                    <div>
                        <div class="stat-value">85</div>
                        <div class="stat-label">Available Beds</div>
                    </div>
                </div>
            </div>

            <div class="baps-card">
                <div class="table-header" style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                    <h3>Recent Applications Overview</h3>
                    <a href="modules/applications-admin.html" class="btn-baps btn-outline btn-sm">View All</a>
                </div>
                <table id="dashboardTable" class="baps-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Mandir</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- Shared Logic --- 
        function loadState(key, defaultVal) {
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : defaultVal;
        }
        function saveState(key, val) {
            localStorage.setItem(key, JSON.stringify(val));
        }

        // --- Session ---
        (function initSession() {
            const userStr = localStorage.getItem('baps_current_user');
            if (userStr) {
                const user = JSON.parse(userStr);
                document.getElementById('sideUserName').innerText = user.name;
                document.getElementById('sideUserRole').innerText = user.title;
                const initials = user.name.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase();
                document.getElementById('avatarInitials').innerText = initials;
            }
        })();

        const state = {
            currentAppIndex: -1,
            isFormDownloaded: false,
            gallery: loadState('baps_gallery_images', []),
            news: loadState('baps_news', []),
            staff: loadState('baps_staff', []),
            gatepass: loadState('baps_gatepass', [])
        };

        // --- Navigation ---
        function showSection(sectionId, element) {
            document.querySelectorAll('.cms-section').forEach(el => el.style.display = 'none');
            const target = document.getElementById('section-' + sectionId);
            if (target) {
                target.style.display = 'block';
                target.classList.add('animate-fade');
            }

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (element) element.classList.add('active');

            const titleMap = {
                'dashboard': 'Dashboard',
                'verification': 'Verification Centre',
                'applications': 'Application Manager',
                'rooms': 'Room Allocation',
                'news': 'News & Events CMS',
                'gallery': 'Gallery Manager',
                'settings': 'System Settings'
            };
            document.getElementById('pageTitle').innerText = titleMap[sectionId] || 'BAPS APC';

            if (sectionId === 'verification') loadVerificationTable();
            if (sectionId === 'applications') loadAppManager();
            if (sectionId === 'rooms') loadRooms();
            if (sectionId === 'gallery') renderGallery();
            if (sectionId === 'news') renderNews();
        }

        // --- Data Loading ---
        function loadData() {
            const apps = JSON.parse(localStorage.getItem('baps_applications') || '[]');
            const total = apps.length;
            const verified = apps.filter(a => a.status === 'Verified').length;
            const pending = apps.filter(a => a.status === 'Pending').length;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-verified').innerText = verified;
            document.getElementById('stat-pending').innerText = pending;

            const dbTable = document.getElementById('dashboardTableBody');
            dbTable.innerHTML = '';
            if (apps.length === 0) {
                dbTable.innerHTML = '<tr><td colspan="4" style="text-align:center;">No data found.</td></tr>';
            } else {
                apps.slice().reverse().slice(0, 5).forEach(app => {
                    dbTable.innerHTML += `
                        <tr>
                            <td>${new Date(app.timestamp).toLocaleDateString()}</td>
                            <td style="font-weight:bold;">${app.personal.fullName}</td>
                            <td>${app.verification.mandir}</td>
                            <td><span class="badge ${app.status === 'Verified' ? 'badge-verified' : (app.status === 'Rejected' ? 'badge-rejected' : 'badge-pending')}">${app.status || 'Pending'}</span></td>
                        </tr>`;
                });
            }
        }

        function loadVerificationTable() {
            const apps = JSON.parse(localStorage.getItem('baps_applications') || '[]');
            const vTable = document.getElementById('verificationTableBody');
            vTable.innerHTML = '';

            apps.slice().reverse().forEach((app, index) => {
                const realIndex = apps.length - 1 - index;
                const isVerified = app.status === 'Verified';
                vTable.innerHTML += `
                    <tr>
                         <td><b>${app.personal.fullName}</b><br><small style="color:#999">${app.personal.mobile}</small></td>
                        <td>${app.verification.mandir}</td>
                        <td><span class="badge ${isVerified ? 'badge-verified' : (app.status === 'Rejected' ? 'badge-rejected' : 'badge-pending')}">${app.status || 'Pending'}</span></td>
                        <td><button class="btn-baps btn-outline" style="padding:0.4rem 1rem; font-size:0.8rem;" onclick="openOfficeModal(${realIndex})">View</button></td>
                    </tr>
                `;
            });
        }

        function loadAppManager() {
            const apps = JSON.parse(localStorage.getItem('baps_applications') || '[]');
            const table = document.getElementById('appManagerTable');
            table.innerHTML = '';
            apps.forEach((app, i) => {
                table.innerHTML += `<tr>
                    <td>#${1000 + i}</td>
                    <td><b>${app.personal.fullName}</b></td>
                    <td>${app.academic.course}</td>
                    <td>${app.personal.mobile}</td>
                    <td><span class="badge ${app.status === 'Verified' ? 'badge-verified' : 'badge-pending'}">${app.status || 'Pending'}</span></td>
                    <td><button class="btn-baps btn-outline" style="padding:0.3rem 0.8rem;">Edit</button></td>
                 </tr>`;
            });
        }

        function loadRooms() {
            const grid = document.getElementById('roomGrid');
            grid.innerHTML = '';
            for (let i = 101; i <= 120; i++) {
                const isFree = Math.random() > 0.4;
                grid.innerHTML += `
                    <div style="background:${isFree ? '#E8F5E9' : '#FFEBEE'}; padding:1rem; border-radius:8px; text-align:center; border:1px solid ${isFree ? '#C8E6C9' : '#FFCDD2'}">
                        <i class="fa-solid fa-bed" style="color:${isFree ? '#2E7D32' : '#C62828'}; font-size:1.5rem; margin-bottom:0.5rem;"></i>
                        <div style="font-weight:bold;">Room ${i}</div>
                        <small style="color:${isFree ? '#2E7D32' : '#C62828'}">${isFree ? 'Available' : 'Occupied'}</small>
                    </div>
                `;
            }
        }

        // --- Modal Logic ---
        // --- Modal Logic ---
        window.simulateDownload = function (btn, docName) {
            // Universal download function (same as student.html)
            if (btn.disabled) return;
            const originalHtml = btn.innerHTML;
            const originalWidth = btn.offsetWidth;
            btn.disabled = true;
            if (originalWidth) btn.style.width = originalWidth + 'px';
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Downloading...`;

            setTimeout(() => {
                btn.innerHTML = `<i class="fa-solid fa-check"></i> Done`;
                // Fake File
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent('Dummy file: ' + docName));
                element.setAttribute('download', docName + '.pdf');
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    btn.style.width = '';
                }, 2000);
            }, 1000);
        };

        function openOfficeModal(index) {
            currentAppIndex = index;
            isFormDownloaded = false;
            const apps = JSON.parse(localStorage.getItem('baps_applications') || '[]');
            const app = apps[index];
            if (!app) return;
            const modal = document.getElementById('officeModal');
            document.getElementById('modalContent').innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; background: #eee; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 3px solid var(--c-gold);">
                         <i class="fa-solid fa-user" style="font-size: 3rem; color: #ccc;"></i>
                    </div>
                    <div style="font-weight: bold; font-size: 1.4rem; font-family:var(--font-heading); color: var(--c-navy);">${app.personal.fullName}</div>
                    <div style="color: #666;">${app.academic.course}</div>
                    <div style="margin-top: 1rem;"><span class="badge ${app.status === 'Verified' ? 'badge-verified' : 'badge-pending'}" style="font-size:0.9rem;">${app.status || 'Pending'}</span></div>
                </div>
                <div>
                     <h4 style="border-bottom:1px solid #eee; padding-bottom:0.5rem;">Contact Info</h4>
                     <p><strong>Mobile:</strong> ${app.personal.mobile}</p>
                     <p><strong>Email:</strong> ${app.personal.email}</p>
                     <p><strong>City:</strong> ${app.personal.city}</p>
                     <br>
                     <h4 style="border-bottom:1px solid #eee; padding-bottom:0.5rem;">Satsang Reference</h4>
                     <p><strong>Mandir:</strong> ${app.verification.mandir}</p>
                     <p><strong>Kothari:</strong> ${app.verification.kothari}</p>
                     
                     <div style="margin-top: 1.5rem; background: #fafafa; padding: 1rem; border-radius: 8px;">
                        <strong><i class="fa-solid fa-paperclip"></i> Documents</strong>
                        <div style="display:flex; justify-content:space-between; margin-top:0.5rem; align-items:center;">
                            <span>Application Form</span>
                            <button class="btn-baps btn-outline" style="font-size:0.8rem; padding: 0.3rem 0.6rem;" onclick="downloadForm(this)">
                                <i class="fa-solid fa-download"></i> Download
                            </button>
                        </div>
                     </div>
                </div>
            `;
            modal.style.display = 'flex';
        }
        function closeModal() { document.getElementById('officeModal').style.display = 'none'; }

        function downloadForm(btn) {
            simulateDownload(btn, 'Application_Form');
            isFormDownloaded = true;
        }

        function processApp(status) {
            if (status === 'Verified' && !isFormDownloaded) return alert("Please download and verify the form first.");
            const apps = JSON.parse(localStorage.getItem('baps_applications') || '[]');
            if (apps[currentAppIndex]) {
                apps[currentAppIndex].status = status;
                localStorage.setItem('baps_applications', JSON.stringify(apps));
                alert(`Application ${status}!`);
                closeModal();
                loadVerificationTable();
                loadData();
            }
        }

        // --- Gallery & News Placeholders ---
        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            if (grid) grid.innerHTML = state.gallery.map((img, i) => `<div style="aspect-ratio:1; background:#ddd; border-radius:8px; background-image:url('${img.url}'); background-size:cover;"></div>`).join('');
        }
        function renderNews() {
            const list = document.getElementById('newsList');
            if (list) list.innerHTML = state.news.map(n => `<div style="padding:1rem; border-bottom:1px solid #eee;"><strong>${n.title}</strong><span style="float:right; color:green">Published</span></div>`).join('');
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>

    <!-- EXTENSIONS (DSA SEARCH & TASKS) -->
    <script type="module" src="/src/admin-extensions.ts"></script>
</body>

</html>